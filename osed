#!/usr/bin/env python3
"""
osed - Unified CLI for OSED exploit development tools

This script provides a single entry point for all OSED tools:
  - egghunter: Generate egghunter shellcode
  - pattern: Create/find cyclic patterns for offset detection
  - gadgets: Find and categorize ROP gadgets
  - utils: Utility functions (pattern, pack/unpack)

Usage:
    osed <command> [options]
    osed egghunter -t w00t -b 00 0a 0d
    osed pattern create 1000
    osed pattern find 0x41414141
    osed gadgets -f binary.exe -b 00 0a

For WinDbg scripts (find-ppr, find-bad-chars, search), run them
directly inside WinDbg with: !py <script.py> [args]
"""
import sys
import os
import argparse
from pathlib import Path

# Add the script directory to path for imports
SCRIPT_DIR = Path(__file__).parent.resolve()
sys.path.insert(0, str(SCRIPT_DIR))

# Version info
__version__ = "2.0.0"
__author__ = "epi / OSED community"


def print_banner():
    """Print the OSED tools banner."""
    banner = f"""
 ██████╗ ███████╗███████╗██████╗       ████████╗ ██████╗  ██████╗ ██╗     ███████╗
██╔═══██╗██╔════╝██╔════╝██╔══██╗      ╚══██╔══╝██╔═══██╗██╔═══██╗██║     ██╔════╝
██║   ██║███████╗█████╗  ██║  ██║  ████╗  ██║   ██║   ██║██║   ██║██║     ███████╗
██║   ██║╚════██║██╔══╝  ██║  ██║  ╚═══╝  ██║   ██║   ██║██║   ██║██║     ╚════██║
╚██████╔╝███████║███████╗██████╔╝         ██║   ╚██████╔╝╚██████╔╝███████╗███████║
 ╚═════╝ ╚══════╝╚══════╝╚═════╝          ╚═╝    ╚═════╝  ╚═════╝ ╚══════╝╚══════╝
                                                                    v{__version__}
    Offensive Security Exploit Development Toolkit
"""
    print(banner)


def cmd_egghunter(args):
    """Run the egghunter generator."""
    import subprocess
    cmd = [sys.executable, str(SCRIPT_DIR / "egghunter.py")]

    if args.tag:
        cmd.extend(["-t", args.tag])
    if args.bad_chars:
        cmd.extend(["-b"] + args.bad_chars)
    if args.seh:
        cmd.append("-s")
    if args.format:
        cmd.extend(["-f", args.format])
    if args.output:
        cmd.extend(["-o", args.output])
    if args.verbose:
        cmd.append("-v")
    if args.varname:
        cmd.extend(["-n", args.varname])

    return subprocess.call(cmd)


def cmd_pattern(args):
    """Run the pattern generator/finder."""
    import subprocess
    cmd = [sys.executable, str(SCRIPT_DIR / "pattern.py")]

    if args.pattern_cmd == "create":
        cmd.extend(["create", str(args.length)])
        if args.charset:
            cmd.extend(["-c", args.charset])
        if args.output:
            cmd.extend(["-o", args.output])
    elif args.pattern_cmd == "find":
        cmd.extend(["find", args.sequence])
        if args.charset:
            cmd.extend(["-c", args.charset])

    return subprocess.call(cmd)


def cmd_gadgets(args):
    """Run the gadget finder."""
    import subprocess
    cmd = [sys.executable, str(SCRIPT_DIR / "find-gadgets.py")]

    cmd.extend(["-f"] + args.files)
    if args.bad_chars:
        cmd.extend(["-b"] + args.bad_chars)
    if args.arch:
        cmd.extend(["-a", args.arch])
    if args.output:
        cmd.extend(["-o", args.output])
    if args.color:
        cmd.append("-c")
    if args.skip_rp:
        cmd.append("-s")
    if args.json:
        cmd.append("-j")
    if args.json_output:
        cmd.extend(["--json-output", args.json_output])

    return subprocess.call(cmd)


def cmd_info(args):
    """Display information about available tools."""
    print_banner()

    info = """
Available Commands:
───────────────────────────────────────────────────────────────────────────────

  egghunter    Generate egghunter shellcode for staged payload delivery
               Variants: NtAccessCheckAndAuditAlarm (35 bytes), SEH (69 bytes)

  pattern      Cyclic pattern generator for finding buffer overflow offsets
               Subcommands: create, find

  gadgets      Find and categorize ROP gadgets from binary files
               Uses both ropper and rp++ for comprehensive coverage

WinDbg Scripts (run inside WinDbg with pykd):
───────────────────────────────────────────────────────────────────────────────

  find-ppr.py       Find pop-pop-ret gadgets for SEH exploits
  find-bad-chars.py Identify bad characters in memory
  search.py         Search memory for patterns

PowerShell Scripts:
───────────────────────────────────────────────────────────────────────────────

  attach-process.ps1   Attach WinDbg to a process with auto-restart
  install-mona.ps1     Install mona.py on Windows lab VM

Quick Start Examples:
───────────────────────────────────────────────────────────────────────────────

  # Generate egghunter with custom tag
  osed egghunter -t w00t -b 00 0a 0d

  # Create 1000-byte cyclic pattern
  osed pattern create 1000

  # Find offset of EIP value
  osed pattern find 0x41414141

  # Find ROP gadgets in binary
  osed gadgets -f vuln.exe -b 00 0a 0d

  # Find gadgets with custom base address
  osed gadgets -f libspp.dll:0x10000000

For detailed help on any command:
  osed <command> --help

Documentation:
  See USAGE.md for comprehensive usage guide
  See README.md for installation and overview
"""
    print(info)
    return 0


def cmd_version(args):
    """Display version information."""
    print(f"osed-scripts version {__version__}")
    print(f"Author: {__author__}")
    print(f"Python: {sys.version}")
    print(f"Location: {SCRIPT_DIR}")
    return 0


def main():
    """Main entry point for the unified CLI."""
    parser = argparse.ArgumentParser(
        prog="osed",
        description="Unified CLI for OSED exploit development tools",
        epilog="Use 'osed <command> --help' for detailed help on each command",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    parser.add_argument(
        "-V", "--version",
        action="store_true",
        help="show version information"
    )

    subparsers = parser.add_subparsers(dest="command", help="Available commands")

    # =========================================================================
    # egghunter subcommand
    # =========================================================================
    egg_parser = subparsers.add_parser(
        "egghunter",
        help="Generate egghunter shellcode",
        description="Generate egghunter shellcode for staged payload delivery"
    )
    egg_parser.add_argument(
        "-t", "--tag",
        default="c0d3",
        help="4-character tag to search for (default: c0d3)"
    )
    egg_parser.add_argument(
        "-b", "--bad-chars",
        nargs="+",
        default=["00"],
        help="Bad characters to check (space-separated hex, default: 00)"
    )
    egg_parser.add_argument(
        "-s", "--seh",
        action="store_true",
        help="Generate SEH-based egghunter (69 bytes) instead of NtAccess (35 bytes)"
    )
    egg_parser.add_argument(
        "-f", "--format",
        choices=["python", "c", "raw", "hex", "escaped"],
        default="python",
        help="Output format (default: python)"
    )
    egg_parser.add_argument(
        "-o", "--output",
        metavar="FILE",
        help="Write output to file"
    )
    egg_parser.add_argument(
        "-v", "--verbose",
        action="store_true",
        help="Show assembly with corresponding bytes"
    )
    egg_parser.add_argument(
        "-n", "--varname",
        default="egghunter",
        help="Variable name for output (default: egghunter)"
    )
    egg_parser.set_defaults(func=cmd_egghunter)

    # =========================================================================
    # pattern subcommand
    # =========================================================================
    pattern_parser = subparsers.add_parser(
        "pattern",
        help="Cyclic pattern generator/finder",
        description="Generate or find offsets in cyclic patterns for buffer overflows"
    )
    pattern_sub = pattern_parser.add_subparsers(dest="pattern_cmd", help="Pattern operation")

    # pattern create
    create_parser = pattern_sub.add_parser(
        "create",
        help="Generate a cyclic pattern"
    )
    create_parser.add_argument(
        "length",
        type=int,
        help="Length of pattern to generate"
    )
    create_parser.add_argument(
        "-c", "--charset",
        help="Custom character set"
    )
    create_parser.add_argument(
        "-o", "--output",
        help="Output file"
    )

    # pattern find
    find_parser = pattern_sub.add_parser(
        "find",
        help="Find offset in cyclic pattern"
    )
    find_parser.add_argument(
        "sequence",
        help="Sequence to find (hex address like 0x41414141 or string like Aa0A)"
    )
    find_parser.add_argument(
        "-c", "--charset",
        help="Custom character set used in pattern"
    )

    pattern_parser.set_defaults(func=cmd_pattern)

    # =========================================================================
    # gadgets subcommand
    # =========================================================================
    gadget_parser = subparsers.add_parser(
        "gadgets",
        help="Find and categorize ROP gadgets",
        description="Find and categorize ROP gadgets from binary files"
    )
    gadget_parser.add_argument(
        "-f", "--files",
        nargs="+",
        required=True,
        help="Binary files to analyze (use file:0xBASE for custom base address)"
    )
    gadget_parser.add_argument(
        "-b", "--bad-chars",
        nargs="+",
        default=[],
        help="Bad characters to filter (space-separated hex)"
    )
    gadget_parser.add_argument(
        "-a", "--arch",
        choices=["x86", "x86_64"],
        default="x86",
        help="Target architecture (default: x86)"
    )
    gadget_parser.add_argument(
        "-o", "--output",
        default="found-gadgets.txt",
        help="Output file for all gadgets (default: found-gadgets.txt)"
    )
    gadget_parser.add_argument(
        "-c", "--color",
        action="store_true",
        help="Colorize output"
    )
    gadget_parser.add_argument(
        "-s", "--skip-rp",
        action="store_true",
        help="Skip rp++ integration"
    )
    gadget_parser.add_argument(
        "-j", "--json",
        action="store_true",
        help="Output in JSON format"
    )
    gadget_parser.add_argument(
        "--json-output",
        metavar="FILE",
        help="JSON output file"
    )
    gadget_parser.set_defaults(func=cmd_gadgets)

    # =========================================================================
    # info subcommand
    # =========================================================================
    info_parser = subparsers.add_parser(
        "info",
        help="Display information about available tools"
    )
    info_parser.set_defaults(func=cmd_info)

    # =========================================================================
    # version subcommand
    # =========================================================================
    version_parser = subparsers.add_parser(
        "version",
        help="Display version information"
    )
    version_parser.set_defaults(func=cmd_version)

    # Parse arguments
    args = parser.parse_args()

    # Handle version flag
    if args.version:
        return cmd_version(args)

    # If no command specified, show info
    if not args.command:
        cmd_info(args)
        return 0

    # Handle pattern subcommand without sub-subcommand
    if args.command == "pattern" and not args.pattern_cmd:
        pattern_parser.print_help()
        return 1

    # Execute the command
    if hasattr(args, "func"):
        return args.func(args)
    else:
        parser.print_help()
        return 1


if __name__ == "__main__":
    sys.exit(main())
